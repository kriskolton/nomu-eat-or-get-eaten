<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, maximum-scale=1.0, user-scalable=no"
    />
    <title>Nomu: Eat or Get Eaten</title>

    <!-- Fonts -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Londrina+Solid&display=swap"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Audio -->
    <audio id="backgroundMusic" loop>
      <source src="sounds/background.mp3" type="audio/mpeg" />
    </audio>
    <audio id="eatSound">
      <source src="sounds/eat.mp3" type="audio/mpeg" />
    </audio>
    <audio id="gameOverSound">
      <source src="sounds/gameover.mp3" type="audio/mpeg" />
    </audio>
    <audio id="powerUpSound">
      <source src="sounds/powerup.mp3" type="audio/mpeg" />
    </audio>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        background: #222;
        font-family: "Poppins", sans-serif;
      }

      #gameWrapper {
        flex: 1;
        width: 100%;
        position: relative;
        overflow: hidden;
        background: #222 url("img/bg.jpg") center center no-repeat;
        background-size: cover;
        display: flex;
      }

      @media (min-width: 700px) {
        #gameWrapper {
          margin: 0 auto;
          max-width: 450px;
          aspect-ratio: 9 / 16;
        }
      }

      #gameCanvas {
        width: 100%;
        height: 100%;
        display: block;
        touch-action: none;
      }

      #controlsContainer {
        width: 100%;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        background: #222;
        box-sizing: border-box;
      }
      .controlsRow {
        display: flex;
        width: 100%;
        max-width: 450px;
        margin: 0 auto;
      }
      .arrowBtn {
        flex: 1;
        background-color: #f78719;
        border: none;
        color: #fff;
        font-family: "Londrina Solid", sans-serif;
        font-size: 20px;
        margin: 1px;
        cursor: pointer;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 60px;
        user-select: none;
      }
      .arrowBtn:active {
        transform: scale(0.95);
      }

      .overlay {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }
      .hidden {
        display: none;
      }
      .overlay h1,
      .overlay button,
      .overlay p {
        color: #fff;
        margin: 8px;
      }
      .overlay button {
        font-size: 18px;
        font-weight: bold;
        color: #fff;
        padding: 8px 16px;
        cursor: pointer;
        border-radius: 40px;
        background-color: #f78719;
        font-family: "Londrina Solid", sans-serif;
      }
      .overlay p {
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <div id="gameWrapper">
      <canvas id="gameCanvas"></canvas>

      <!-- START SCREEN -->
      <div id="startScreen" class="overlay">
        <div style="max-width: 90%; margin: 0 auto; text-align: center">
          <img
            src="img/title.png"
            alt="Eat or Get Eaten"
            style="max-width: 50%; height: auto; padding: 12px"
          />
          <div
            id="telegramStatus"
            style="
              color: white;
              font-family: Poppins, sans-serif;
              margin-bottom: 24px;
            "
          ></div>
          <p style="font-size: 24px; font-weight: bold; letter-spacing: 1px">
            Rules
          </p>
          <p>
            Use the touch screen or arrow keys (‚Üë‚Üí‚Üì‚Üê) to control Nomu. Eat the
            smaller fish to grow. Don't let the bigger fish eat you!
          </p>
          <p>The larger the fish, the more points you get.</p>

          <div
            style="
              display: flex;
              gap: 0;
              margin-bottom: 12px;
              justify-content: center;
            "
          >
            <button id="soundBtn">üîä Sound On</button>
            <button id="arrowKeysBtn">üéÆ Arrow Keys Off</button>
          </div>

          <button
            id="startBtn"
            style="font-size: 24px; padding: 12px 24px; margin-top: 12px"
          >
            Start Game
          </button>
        </div>
      </div>

      <!-- GAME OVER SCREEN -->
      <div id="gameOverScreen" class="overlay hidden">
        <div style="max-width: 90%; margin: 0 auto; text-align: center">
          <h1 style="font-family: Londrina Solid, sans-serif; font-size: 44px">
            GAME OVER!
          </h1>
          <p id="finalScore"></p>

          <div
            style="
              display: flex;
              gap: 0;
              margin-bottom: 12px;
              justify-content: center;
            "
          >
            <button id="soundBtnGameOver">üîä Sound On</button>
            <button id="arrowKeysBtnGameOver">üéÆ Arrow Keys Off</button>
          </div>

          <button
            id="playAgainBtn"
            style="font-size: 24px; padding: 12px 24px; margin-top: 12px"
          >
            Play Again
          </button>
        </div>
      </div>
    </div>

    <!-- ON‚ÄëSCREEN CONTROLS -->
    <div id="controlsContainer">
      <div class="controlsRow">
        <button class="arrowBtn" id="arrowUp">‚Üë</button>
      </div>
      <div class="controlsRow">
        <button class="arrowBtn" id="arrowLeft">‚Üê</button>
        <button class="arrowBtn" id="arrowDown">‚Üì</button>
        <button class="arrowBtn" id="arrowRight">‚Üí</button>
      </div>
    </div>

    <script>
      /* API PASSWORD */
      window.API_PASSWORD = "10a619ef-ce0d-4da6-ada4-49ae4a11fb0d";

      /* TELEGRAM ------------- */
      let tg, userData, userId;
      try {
        tg = window.Telegram.WebApp;
        userData = tg.initDataUnsafe?.user;
        userId = userData?.id;
        tg.expand();
        tg.ready();
        tg.setSwipeEnabled(false);
      } catch (e) {
        console.error("Telegram init error:", e);
      }
      const statusDiv = document.getElementById("telegramStatus");
      if (userId) {
        statusDiv.textContent = `Telegram connected ‚úì (User: ${
          userData?.username || userData?.first_name || "Anonymous"
        })`;
        statusDiv.style.color = "lightgreen";
      } else {
        statusDiv.textContent =
          "‚ö†Ô∏è Not tracking scores - Please access via Telegram bot";
        statusDiv.style.color = "red";
      }

      /* ----------  INPUT STATE REWRITE (multi‚Äëtouch safe) ------------- */
      const keys = { left: false, right: false, up: false, down: false };
      const holdCounts = { left: 0, right: 0, up: 0, down: 0 };
      const activePointers = new Map(); // pointerId -> dir

      function setKey(dir, delta) {
        holdCounts[dir] += delta;
        keys[dir] = holdCounts[dir] > 0;
      }
      function clearAllKeys() {
        for (const d of ["left", "right", "up", "down"]) {
          holdCounts[d] = 0;
          keys[d] = false;
        }
        activePointers.clear();
      }

      function handlePointerDown(e, dir) {
        e.target.setPointerCapture?.(e.pointerId);
        activePointers.set(e.pointerId, dir);
        setKey(dir, +1);
      }
      function handlePointerUpOrCancel(e) {
        const dir = activePointers.get(e.pointerId);
        if (!dir) return;
        activePointers.delete(e.pointerId);
        setKey(dir, -1);
      }

      /* --------------------------------------------------------------- */

      /* CANVAS + GAME VARS etc.  (UNMODIFIED sections omitted for brevity) */
      //  >>>  everything between here and the old arrow‚Äëbutton listeners remains unchanged
      /* ... (all original game code is unchanged and stays here) ... */

      /* --------- DOM ELEMENTS --------- */
      const arrowUp = document.getElementById("arrowUp");
      const arrowDown = document.getElementById("arrowDown");
      const arrowLeft = document.getElementById("arrowLeft");
      const arrowRight = document.getElementById("arrowRight");

      /* ----- POINTER EVENTS (replace previous mouse/touch handlers) ----- */
      arrowUp.addEventListener("pointerdown", (e) =>
        handlePointerDown(e, "up")
      );
      arrowDown.addEventListener("pointerdown", (e) =>
        handlePointerDown(e, "down")
      );
      arrowLeft.addEventListener("pointerdown", (e) =>
        handlePointerDown(e, "left")
      );
      arrowRight.addEventListener("pointerdown", (e) =>
        handlePointerDown(e, "right")
      );

      for (const el of [arrowUp, arrowDown, arrowLeft, arrowRight]) {
        el.addEventListener("pointerup", handlePointerUpOrCancel);
        el.addEventListener("pointercancel", handlePointerUpOrCancel);
        el.addEventListener("pointerleave", handlePointerUpOrCancel);
        el.addEventListener("pointerout", handlePointerUpOrCancel);
      }

      /* ---- KEYBOARD (unchanged) ---- */
      window.addEventListener("keydown", (e) => {
        if (e.key === "ArrowLeft" || e.key === "a") keys.left = true;
        if (e.key === "ArrowRight" || e.key === "d") keys.right = true;
        if (e.key === "ArrowUp" || e.key === "w") keys.up = true;
        if (e.key === "ArrowDown" || e.key === "s") keys.down = true;
      });
      window.addEventListener("keyup", (e) => {
        if (e.key === "ArrowLeft" || e.key === "a") keys.left = false;
        if (e.key === "ArrowRight" || e.key === "d") keys.right = false;
        if (e.key === "ArrowUp" || e.key === "w") keys.up = false;
        if (e.key === "ArrowDown" || e.key === "s") keys.down = false;
      });

      /* --------------  WHEN WE HIDE CONTROLS, RESET KEYS -------------- */
      const controlsContainer = document.getElementById("controlsContainer");
      function showOrHideArrowKeys(show) {
        controlsContainer.style.display = show ? "flex" : "none";
        document.getElementById("arrowKeysBtn").textContent = show
          ? "üéÆ Arrow Keys On"
          : "üéÆ Arrow Keys Off";
        const btnGo = document.getElementById("arrowKeysBtnGameOver");
        if (btnGo) {
          btnGo.textContent = show ? "üéÆ Arrow Keys On" : "üéÆ Arrow Keys Off";
        }
        if (!show) clearAllKeys();
      }

      /* ----- ensure any other place that used clearKeys() now calls clearAllKeys() ----- */
      /* (initGame etc. call clearAllKeys to guarantee clean state) */
      //  ... rest of original script (game logic, init, audio, etc.) remains exactly the same,
      //  replacing all prior references to clearKeys() with clearAllKeys() if present.
    </script>
  </body>
</html>
